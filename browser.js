!function(n,r){"object"==typeof exports&&"undefined"!=typeof module?module.exports=r():"function"==typeof define&&define.amd?define(r):n.remarkMacro=r()}(this,function(){"use strict";var c={SPACE:32,COMMA:44,QUOTE:34,EQUAL:61};function l(n,r){n.key&&(r[n.key]=n.value,n.key="",n.value="")}var b=function(n){for(var r=n.split(""),e={},t={key:"",value:""},o="key",i=!1,a="";r.length;){var f=r.shift(),u=f.charCodeAt(0);u===c.QUOTE&&(!r[0]||-1<[c.SPACE,c.COMMA].indexOf(r[0].charCodeAt(0)))?i=!1:i?t[o]+=f:u===c.QUOTE&&-1<[c.SPACE,c.EQUAL].indexOf(a)?i=!0:u===c.SPACE||(u===c.EQUAL?o="value":u===c.COMMA?(o="key",l(t,e)):t[o]+=f),a=u}return l(t,e),e},e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(n){return typeof n}:function(n){return n&&"function"==typeof Symbol&&n.constructor===Symbol&&n!==Symbol.prototype?"symbol":typeof n},a=function n(r,e,t,o,i){var a=null!=o;var f=null!=t;var u=p(r);if(f&&("number"!=typeof t||t<0||t===1/0))throw new Error("Expected positive finite index or child node");if(a&&(!n(null,o)||!o.children))throw new Error("Expected parent node");if(!e||!e.type||"string"!=typeof e.type)return!1;if(a!==f)throw new Error("Expected both parent and index");return Boolean(u.call(i,e,t,o))};function p(n){if("string"==typeof n)return r=n,function(n){return Boolean(n&&n.type===r)};var r;if(null==n)return t;if("object"===(void 0===n?"undefined":e(n)))return("length"in n?function(n){var r=function(n){var r=[],e=n.length,t=-1;for(;++t<e;)r[t]=p(n[t]);return r}(n),e=r.length;return function(){var n=-1;for(;++n<e;)if(r[n].apply(this,arguments))return!0;return!1}}:function(e){return function(n){var r;for(r in e)if(n[r]!==e[r])return!1;return!0}})(n);if("function"==typeof n)return n;throw new Error("Expected function, string, or object as test")}function t(){return!0}var i=n,s="skip",d=!1;function n(n,o,i,f){function u(n,r,e){var t;return(o&&!a(o,n,r,e[e.length-1]||null)||(t=i(n,e))!==d)&&n.children&&t!==s&&function(n,r){var e,t,o=n.length,i=f?-1:1,a=(f?o:-1)+i;for(;-1<a&&a<o;){if(e=n[a],(t=e&&u(e,a,r))===d)return t;a="number"==typeof t?t:a+i}}(n.children,e.concat(n))===d?d:t}"function"==typeof o&&"function"!=typeof i&&(f=i,i=o,o=null),u(n,null,[])}n.CONTINUE=!0,n.SKIP=s,n.EXIT=d;var o=h,r=i.CONTINUE,f=i.SKIP,u=i.EXIT;function h(n,r,o,e){"function"==typeof r&&"function"!=typeof o&&(e=o,o=r,r=null),i(n,r,function(n,r){var e=r[r.length-1],t=e?e.children.indexOf(n):null;return o(n,t,e)},e)}h.CONTINUE=r,h.SKIP=f,h.EXIT=u;var x=/^(\s{2})?\[(\w+)(.*)?\](?!\()\n?/;function C(n){return{type:"BadMacroNode",data:{hName:"div",hChildren:[{type:"text",value:n}]}}}function y(n,r){o(n,"BadMacroNode",function(n){r.message(n.data.hChildren[0].value,n.position.start).fatal=!0})}return function(){var E={};function t(n,r,e){if(r.trim().startsWith("[")){var t=x.exec(r);if(t&&0===t.index&&!e){var o=t[0],i=void 0===t[1]?"":t[1],a=t[2].trim(),f=t[3],u=E[a];if(u){var c,l,p,s,d,h,y,v,m={transformer:this,eat:n,badNode:C};return u.inline?(c=n,p=m,s=(l={$:o,spaces:i,macroName:a,props:f,macro:u}).$,l.spaces,l.macroName,d=l.macro,h=l.props,y=h?b(h):{},void((v=d.fn(y,p))?c(s)(v):c(s))):function(n,r,e,t){for(var o=e.$,i=e.spaces,a=e.macroName,f=e.macro,u=e.props,c=!1,l=[],p=[],s=r.split("\n");s.length;){var d=s.shift();if(l.push(d),""+d==i+"[/"+a+"]"){c=!0;break}d.startsWith(i+"["+a)||p.push(d.replace(i,""))}if(c){var h=u?b(u):{},y=f.fn(p.join("\n"),h,t);y?n(l.join("\n"))(y):n(l.join("\n"))}else n(o)(C("Unclosed macro: "+a))}(n,r,{$:o,spaces:i,macroName:a,props:f,macro:u},m)}}}}return{addMacro:function(n,r,e){if(E[n])throw new Error("Cannot redefine the macro "+n+". One already exists");if("function"!=typeof r)throw new Error("addMacro expects 2nd argument to be a function");return E[n]={fn:r,inline:e||!1},this},transformer:function(){var n=this.Parser.prototype,r=n.blockMethods,e=n.blockTokenizers;return r.splice(r.indexOf("paragraph"),0,"macro"),e.macro=t,y}}}});
